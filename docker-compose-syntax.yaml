version: "3.9"  # Compose file version (3.9 = latest stable for Swarm + Compose)

###############################
#          SERVICES
###############################
services:

  ###############################
  #        WEB APPLICATION
  ###############################
  app:
    container_name: my_app_container   # Optional: give a fixed name to the container

    # -------------------------------
    # IMAGE OR BUILD CONFIG
    # -------------------------------

    # If you have Dockerfile and want to build locally:
    build:
      context: ./app          # Path to directory containing Dockerfile
      dockerfile: Dockerfile  # Filename (optional if name is exactly "Dockerfile")
      args:                   # Build-time variables
        APP_ENV: production
      target: final           # Multi-stage build final stage
      ssh: default            # Pass SSH key during build (for private repos)

    # If both "image" and "build" exist:
    # - build: tells HOW to build
    # - image: tells final NAME/TAG for the built image
    image: myapp:latest       # Useful for tagging + pushing to registry

    # -------------------------------
    # COMMAND & ENTRYPOINT
    # -------------------------------
    command: ["python3", "app.py"]      # Override default CMD in Dockerfile
    entrypoint: ["/docker-entrypoint.sh"]  # Override default ENTRYPOINT

    working_dir: /usr/src/app           # Set working directory
    user: "1000:1000"                   # Run container as this UID:GID (non-root)

    # -------------------------------
    # ENVIRONMENT VARIABLES
    # -------------------------------
    environment:
      APP_MODE: "production"            # Environment variable
      DB_HOST: "mysql"                  # Link to other service
      SECRET_KEY: "${SECRET_KEY}"       # Load from machine environment variable

    env_file:
      - .env         # Load environment variables from .env file

    # -------------------------------
    # NETWORK PORTS
    # -------------------------------
    ports:
      - "8080:80"     # HOST:CONTAINER â†’ Expose app on localhost:8080

    expose:
      - "80"          # Internal network-only exposure (no host binding)

    # -------------------------------
    # STORAGE / VOLUMES
    # -------------------------------
    volumes:
      - ./app:/usr/share/nginx/html:ro     # Bind mount local directory
      - uploads:/var/www/uploads           # Named volume for persistent storage

    tmpfs:
      - /tmp                                # In-memory filesystem (fast, secure)

    # -------------------------------
    # NETWORKS
    # -------------------------------
    networks:
      - frontend
      - backend

    # -------------------------------
    # DEPENDENCY ORDER
    # -------------------------------
    depends_on:
      - mysql       # Start mysql service first
      - redis       # Start redis service first

    # -------------------------------
    # HEALTH CHECK
    # Checks if the container is actually healthy (not just running).  
    # why it matter:
    # - app inside crashed
    # - DB still starting
    # - service unresponsive
    # - wrong config, stuck, timeout
    # -------------------------------

    healthcheck:               
      test: ["CMD", "curl", "-f", "http://localhost/"]  # Basic health command
      interval: 30s     # Run health check every 30 seconds
      timeout: 5s       # Fail if command takes >5 secs
      retries: 3        # Mark container unhealthy after 3 failures
      start_period: 10s # Grace period for container to boot

    # -------------------------------
    # LOGGING CONFIGURATION
    # Controls how container logs are stored and rotated.
    # By default, Docker logs go into /var/lib/docker/containers/... as "json-file".
    # Usecase:
    # - Prevents logs from growing huge (e.g., 20GB)
    # - Lets you use centralized logging like syslog, fluentd, Loki, splunk, etc.
    # - Controls log retention
    # -------------------------------
    
    logging:
      driver: json-file        # Default docker log driver
      options:
        max-size: "10m"        # Rotate log file at 10MB
        max-file: "3"          # Keep last 3 rotated logs

    # -------------------------------
    # SECURITY OPTIONS
    # -------------------------------
    privileged: false           # true = full host access (dangerous)
    read_only: false            # root filesystem read-only
    cap_add:                    # Add Linux kernel capabilities
      - NET_ADMIN               # Example: allow network admin operations
    cap_drop:                   # Drop capabilities for security
      - MKNOD
    security_opt:
      - no-new-privileges:true  # Prevent privilege escalation

    # -------------------------------
    # DEVICE MAPPING (HARDWARE ACCESS)
    # -------------------------------
    devices:
      - "/dev/ttyUSB0:/dev/ttyUSB0"   # Pass host USB/serial/GPU device to container

    # -------------------------------
    # RESTART POLICY
    # -------------------------------
    restart: unless-stopped   # Keep running unless explicitly stopped

    # -------------------------------
    # DOCKER SWARM DEPLOY OPTIONS
    # (Ignored by docker-compose, used by: docker stack deploy)
    # -------------------------------
    deploy:
      replicas: 2   # Run 2 copies of this service (Swarm-only)
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3

      resources:     # Resource limits
        limits:
          cpus: "0.5"
          memory: 512M
        reservations:
          cpus: "0.2"
          memory: 256M

      placement:     # Scheduling rules for Swarm nodes
        constraints:
          - "node.role == worker"
          - "node.labels.region == asia"

  ###############################
  #        MYSQL DATABASE
  ###############################
  mysql:
    image: mysql:8
    environment:
      MYSQL_ROOT_PASSWORD: rootpass
      MYSQL_DATABASE: appdb
    volumes:
      - mysql_data:/var/lib/mysql      # Persist data
    networks:
      - backend
    restart: always

  ###############################
  #        REDIS CACHE
  ###############################
  redis:
    image: redis:7
    command: ["redis-server", "--appendonly", "yes"]
    ports:
      - "6379:6379"
    networks:
      - backend

###############################
#          VOLUMES
###############################
volumes:
  uploads: {}     # Named volume for persistent user uploads
  mysql_data: {}  # Volume for MySQL DB data

###############################
#          NETWORKS
###############################
networks:
  frontend:
    driver: bridge    # Default driver for local networking
  backend:
    driver: bridge

###############################
#           SECRETS (Swarm only)
###############################
secrets:
  db_password:
    file: ./secrets/db_password.txt

###############################
#           CONFIGS (Swarm only)
###############################
configs:
  nginx_config:
    file: ./config/nginx.conf
